import subprocess
import os

def run_semgrep(target_file, rules_file):
    if not os.path.exists(target_file):
        # print(f"[!] File not found: {target_file}")
        return False

    if not os.path.exists(rules_file):
        # print(f"[!] Rules file not found: {rules_file}")
        return False

    # print(f"[+] Scanning {target_file} using rules from {rules_file}...\n")

    try:
        # Validate UTF-8 encoding for YAML file
        with open(rules_file, encoding="utf-8") as f:
            f.read()

        # Run Semgrep
        result = subprocess.run(
            ["semgrep", "--config", rules_file, target_file],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            encoding="utf-8"
        )

        # if result.stdout:
        #     print("[Semgrep Output]")
        #     print(result.stdout)

        if result.stderr:
            print("[Semgrep Errors]")
            print(result.stderr)

        if result.returncode == 0:
            print("\n[+] Scan completed successfully.")
            return "finding" in result.stdout.lower()
        else:
            print(f"\n[!] Semgrep exited with code {result.returncode}.")
            return "finding" in result.stdout.lower()

    except UnicodeDecodeError as e:
        print(f"[!] Encoding error in rules file:\n{e}")
        print("[!] Please save the YAML config as UTF-8.")
        return False
    except Exception as e:
        print(f"[!] Error running Semgrep: {e}")
        return False

